@using System.Collections.Generic
@using Microsoft.AspNetCore.Components

@page "/whatsapp"

<div class="whatsapp-page">
    <MudAppBar Elevation="1" Class="whatsapp-appbar">
        <MudIconButton Icon="Icons.Material.Filled.Menu" Color="Color.Inherit" />
        <MudSpacer />
        <MudAppBarSpacer />
        <MudText Typo="Typo.h6" Class="ml-3">Conversas</MudText>
        <MudSpacer />
        <MudIconButton Icon="Icons.Material.Filled.CameraAlt" Color="Color.Inherit" />
        <MudIconButton Icon="Icons.Material.Filled.Search" Color="Color.Inherit" />
        <MudIconButton Icon="Icons.Material.Filled.MoreVert" Color="Color.Inherit" />
    </MudAppBar>

    <div class="whatsapp-content">
        <!-- Filtros -->
        <div class="whatsapp-filters">
            <MudGrid Class="pa-4 ma-0">
                <MudItem xs="12">
                    <MudChipSet T="string" Filter>
                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">Todas</MudChip>
                        <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">Não lidas</MudChip>
                        <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">Favoritos</MudChip>
                        <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">Grupos</MudChip>
                    </MudChipSet>
                </MudItem>
            </MudGrid>
        </div>

        <!-- Conversas Arquivadas -->
        <MudListItem T="string" @onclick="() => HandleArchivedClick()" Class="whatsapp-archived">
            <MudIcon Icon="Icons.Material.Filled.Archive" Color="Color.Default" />
            <MudText Class="ml-3">Arquivadas</MudText>
            <MudSpacer />
            <MudBadge Color="Color.Primary" Size="Size.Small">66</MudBadge>
        </MudListItem>

        <MudDivider />

        <!-- Lista de Conversas -->
        <MudList T="User" Class="pa-0 whatsapp-list">
            @foreach (var user in Users)
            {
                <MudListItem @onclick="() => HandleUserClick(user)">
                    <MudAvatar Color="Color.Primary" Size="Size.Large" Class="mr-3">
                        @GetInitials(user.Phone)
                    </MudAvatar>
                    <MudListItemContent>
                        <MudListItemTitle>@user.Phone</MudListItemTitle>
                        <MudListItemSubTitle>
                            <MudIcon Icon="Icons.Material.Filled.DoneAll" Size="Size.Small" Class="mr-1" Color="Color.Primary" />
                            @user.LastMessage
                        </MudListItemSubTitle>
                    </MudListItemContent>
                    <MudListItemSecondaryContent>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @GetFormattedDate(user.LastMessageDate)
                        </MudText>
                    </MudListItemSecondaryContent>
                </MudListItem>
                <MudDivider />
            }
        </MudList>

        <!-- Botão Nova Conversa -->
        <MudFab Color="Color.Primary" 
                Size="Size.Large" 
                Class="fab-bottom-right"
                Icon="Icons.Material.Filled.Chat">
        </MudFab>
    </div>

    <!-- Menu Inferior -->
    <MudBottomNavigation Breakpoint="Breakpoint.None" 
                         Color="Color.Primary" 
                         Border="true" 
                         Class="elevation-2 whatsapp-bottom-nav">
        
        <!-- Atualizações -->
        <MudBottomNavItem Icon="Icons.Material.Filled.Update" 
                          IconColor="Color.Default"
                          Title="Atualizações" />
        
        <!-- Ligações -->
        <MudBottomNavItem Icon="Icons.Material.Filled.Call" 
                          IconColor="Color.Default"
                          Title="Ligações" />
        
        <!-- Comunidades -->
        <MudBottomNavItem Icon="Icons.Material.Filled.Groups" 
                          IconColor="Color.Default"
                          Title="Comunidades" />
        
        <!-- Conversas -->
        <MudBottomNavItem Icon="Icons.Material.Filled.Chat" 
                          IconColor="Color.Primary"
                          Title="Conversas" />
        
        <!-- Configurações -->
        <MudBottomNavItem Icon="Icons.Material.Filled.Settings" 
                          IconColor="Color.Default"
                          Title="Configurações" />

    </MudBottomNavigation>
</div>

@code {
    private List<User> Users = new List<User>();

    protected override void OnInitialized()
    {
        Users = User.GetFakeUsers(false);
    }

    private string GetInitials(string phone)
    {
        if (string.IsNullOrEmpty(phone))
            return "??";
        
        var parts = phone.Split(' ');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return phone.Length >= 2 ? phone.Substring(0, 2).ToUpper() : phone.ToUpper();
    }

    private string GetFormattedDate(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);

        if (date.Date == today)
            return date.ToString("HH:mm");
        else if (date.Date == yesterday)
            return "ontem";
        else if (date.Year == today.Year)
            return date.ToString("dd/MM");
        else
            return date.ToString("dd/MM/yyyy");
    }

    private void HandleArchivedClick()
    {
        // Lógica para abrir conversas arquivadas
    }

    private void HandleUserClick(User user)
    {
        // Lógica para abrir conversa com o usuário
    }

    
}

<style>
.whatsapp-page {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
    margin: 0;
    padding: 0;
}

.whatsapp-appbar {
    flex-shrink: 0;
    z-index: 1100;
}

.whatsapp-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

.whatsapp-filters {
    flex-shrink: 0;
    border-bottom: 1px solid var(--mud-palette-lines-default);
}

.whatsapp-archived {
    flex-shrink: 0;
}

.whatsapp-list {
    flex: 1;
    overflow-y: auto;
}

.whatsapp-bottom-nav {
    flex-shrink: 0;
    z-index: 1100;
}

.fab-bottom-right {
    position: fixed;
    bottom: 88px;
    right: 24px;
    z-index: 1000;
}

.mud-list {
    scroll-behavior: smooth;
}

.mud-list-item-content {
    min-width: 0;
}

.mud-list-item-secondary-content {
    flex-shrink: 0;
    margin-left: auto;
}
</style>