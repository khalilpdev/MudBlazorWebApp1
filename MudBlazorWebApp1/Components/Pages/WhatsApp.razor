@using System.Collections.Generic
@using Microsoft.AspNetCore.Components

@page "/whatsapp"

<MudAppBar Elevation="1">
    <MudIconButton Icon="Icons.Material.Filled.Menu" Color="Color.Inherit" />
    <MudSpacer />
    <MudAppBarSpacer />
    <MudText Typo="Typo.h6" Class="ml-3">Conversas</MudText>
    <MudSpacer />
    <MudIconButton Icon="Icons.Material.Filled.CameraAlt" Color="Color.Inherit" />
    <MudIconButton Icon="Icons.Material.Filled.Search" Color="Color.Inherit" />
    <MudIconButton Icon="Icons.Material.Filled.MoreVert" Color="Color.Inherit" />
</MudAppBar>

<MudMainContent>
    <MudContainer MaxWidth="MaxWidth.Large" Class="pa-0 pb-20">
        <!-- Filtros -->
        <MudGrid Class="pa-4">
            <MudItem xs="12">
                <MudChipSet T="string" Filter>
                    <MudChip Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">Todas</MudChip>
                    <MudChip Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">Não lidas</MudChip>
                    <MudChip Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">Favoritos</MudChip>
                    <MudChip Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">Grupos</MudChip>
                </MudChipSet>
            </MudItem>
        </MudGrid>

        <!-- Conversas Arquivadas -->
        <MudListItem T="string" @onclick="() => HandleArchivedClick()">
            <MudIcon Icon="Icons.Material.Filled.Archive" Color="Color.Default" />
            <MudText Class="ml-3">Arquivadas</MudText>
            <MudSpacer />
            @* <MudBadge Color="Color.Primary" Size="Size.Small">66</MudBadge> *@
        </MudListItem>

        <MudDivider />

        <!-- Lista de Conversas -->
        <MudList T="User" Class="pa-0" Style="height: calc(100vh - 350px); overflow-y: auto;">
            @foreach (var user in Users)
            {
                <MudListItem @onclick="() => HandleUserClick(user)">
                    <MudAvatar Color="Color.Primary" Size="Size.Large" Class="mr-3">
                        @GetInitials(user.Phone)
                    </MudAvatar>
                    <MudListItemContent>
                        <MudListItemTitle>@user.Phone</MudListItemTitle>
                        <MudListItemSubTitle>
                            <MudIcon Icon="Icons.Material.Filled.DoneAll" Size="Size.Small" Class="mr-1" Color="Color.Primary" />
                            @user.LastMessage
                        </MudListItemSubTitle>
                    </MudListItemContent>
                    <MudListItemSecondaryContent>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @GetFormattedDate(user.LastMessageDate)
                        </MudText>
                    </MudListItemSecondaryContent>
                </MudListItem>
                <MudDivider />
            }
        </MudList>

        <!-- Botão Nova Conversa -->
        <MudFab Color="Color.Primary" 
                Size="Size.Large" 
                Class="fab-bottom-right"
                Icon="Icons.Material.Filled.Chat">
        </MudFab>
    </MudContainer>
</MudMainContent>

<!-- Menu Inferior -->
<MudBottomNavigation Breakpoint="Breakpoint.None" 
                     Color="Color.Primary" 
                     Border="true">
    
    <MudBottomNavItem Icon="Icons.Material.Filled.Update" 
                      IconColor="@(_selectedTab == 0 ? Color.Primary : Color.Default)"
                      Title="Atualizações"
                      OnClick="@(() => OnTabClick(0))" />
    
    <MudBottomNavItem Icon="Icons.Material.Filled.Call" 
                      IconColor="@(_selectedTab == 1 ? Color.Primary : Color.Default)"
                      Title="Ligações"
                      OnClick="@(() => OnTabClick(1))" />
    
    <MudBottomNavItem Icon="Icons.Material.Filled.Groups" 
                      IconColor="@(_selectedTab == 2 ? Color.Primary : Color.Default)"
                      Title="Comunidades"
                      OnClick="@(() => OnTabClick(2))" />
    
    <MudBottomNavItem Icon="Icons.Material.Filled.Chat" 
                      IconColor="@(_selectedTab == 3 ? Color.Primary : Color.Default)"
                      Title="Conversas"
                      OnClick="@(() => OnTabClick(3))" />
    
    <MudBottomNavItem Icon="Icons.Material.Filled.Settings" 
                      IconColor="@(_selectedTab == 4 ? Color.Primary : Color.Default)"
                      Title="Configurações"
                      OnClick="@(() => OnTabClick(4))" />

</MudBottomNavigation>

@code {
    private List<User> Users = new List<User>();
    private int _selectedTab = 3; // Conversas como padrão

    protected override void OnInitialized()
    {
        Users = User.GetFakeUsers(false);
    }

    private string GetInitials(string phone)
    {
        if (string.IsNullOrEmpty(phone))
            return "??";
        
        var parts = phone.Split(' ');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return phone.Length >= 2 ? phone.Substring(0, 2).ToUpper() : phone.ToUpper();
    }

    private string GetFormattedDate(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);

        if (date.Date == today)
            return date.ToString("HH:mm");
        else if (date.Date == yesterday)
            return "ontem";
        else if (date.Year == today.Year)
            return date.ToString("dd/MM");
        else
            return date.ToString("dd/MM/yyyy");
    }

    private void HandleArchivedClick()
    {
        // Lógica para abrir conversas arquivadas
    }

    private void HandleUserClick(User user)
    {
        // Lógica para abrir conversa com o usuário
    }

    private void OnTabClick(int tabIndex)
    {
        _selectedTab = tabIndex;
        // Adicione aqui a lógica para navegar entre as páginas
    }
}

<style>
.fab-bottom-right {
    position: fixed;
    bottom: 80px;
    right: 24px;
    z-index: 999;
}

.mud-list {
    scroll-behavior: smooth;
}

.mud-list-item-content {
    min-width: 0;
}

.mud-list-item-secondary-content {
    flex-shrink: 0;
    margin-left: auto;
}

.mud-bottom-navigation {
    position: fixed;
    bottom: 0;
    width: 100%;
    z-index: 1000;
    box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
}
</style>